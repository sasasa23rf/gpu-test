<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîê GPU Velocit√† Test App</title>
  <style>
    /* --- STILI BASE --- */
    * {margin:0;padding:0;box-sizing:border-box;}
    body {
      font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;display:flex;align-items:center;justify-content:center;
      color:white;padding:10px;
    }
    .container {
      background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);
      border-radius:20px;padding:40px;max-width:800px;width:90%;
      box-shadow:0 8px 32px rgba(0,0,0,0.3);text-align:center;
    }

    /* --- STILI AUTENTICAZIONE --- */
    .auth-section h1 {font-size:2.2em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
    .subtitle {color:rgba(255,255,255,0.8);margin-bottom:30px;font-size:1em;}
    .form-tabs {display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);
      border-radius:15px;padding:5px;}
    .tab-button {flex:1;padding:12px;background:transparent;border:none;
      color:rgba(255,255,255,0.7);border-radius:10px;cursor:pointer;
      transition:all 0.3s ease;font-size:1em;}
    .tab-button.active {background:linear-gradient(45deg,#4facfe,#00f2fe);
      color:white;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
    .form-container {position:relative;overflow:hidden;}
    .form-content {display:none;animation:slideIn 0.3s ease;}
    .form-content.active {display:block;}
    @keyframes slideIn {from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
    .form-group {margin-bottom:20px;text-align:left;}
    label {display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9);font-size:0.95em;}
    input, select {
      width:100%;padding:12px 15px;border:none;border-radius:10px;
      background:rgba(255,255,255,0.15);color:white;font-size:1em;
      transition:all 0.3s ease;backdrop-filter:blur(5px);
    }
    input::placeholder {color:rgba(255,255,255,0.6);}
    input:focus, select:focus {outline:none;background:rgba(255,255,255,0.25);
      box-shadow:0 0 0 2px rgba(79,172,254,0.5);}
    select {cursor:pointer;} select option {background:#333;color:white;}
    .location-grid {display:grid;grid-template-columns:1fr 1fr;gap:15px;}
    
    /* --- STILI TEST GPU --- */
    .gpu-section h1 {font-size:2.2em;margin-bottom:20px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
    .device-info {
        background:rgba(255,255,255,0.1);
        border-radius:10px;
        padding:15px;
        margin:15px 0;
        font-size:0.9em;
        text-align:left;
        display:none;
    }
    .user-record-box {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 10px 15px;
        margin: 15px 0;
        text-align: center;
        display: none;
    }
    .user-record-box h4 {
        margin-bottom: 5px;
        color: rgba(255, 255, 255, 0.8);
    }
    .user-record-box .metric-value {
        font-size: 1.4em;
    }
    .mobile-buttons {
        display:flex;
        flex-direction:column;
        gap:15px;
        margin:20px 0;
    }
    .mobile-buttons button {
        font-size:1.1em;
        padding:12px 25px;
    }
    .progress {
        width:100%;height:20px;
        background:rgba(255,255,255,0.2);
        border-radius:10px;margin:20px 0;overflow:hidden;
    }
    .progress-bar {
        height:100%;background:linear-gradient(90deg,#4facfe,#00f2fe);
        width:0%;transition:width 0.3s ease;
    }
    .progress-text {
        text-align:center;
        margin-top:10px;
        font-size:0.9em;
        color:rgba(255,255,255,0.8);
    }
    .results {
        background:rgba(255,255,255,0.1);
        border-radius:15px;padding:20px;margin-top:20px;text-align:left;
    }
    .metric {
        display:flex;justify-content:space-between;
        margin:8px 0;padding:8px;
        background:rgba(255,255,255,0.05);
        border-radius:8px;
    }
    .metric-value {font-weight:bold;color:#4facfe;}

    /* --- STILI CLASSIFICA --- */
    #leaderboard-section {
      margin-top: 40px;
      background: rgba(0,0,0,0.1);
      border-radius: 15px;
      padding: 20px;
    }
    #leaderboard-section h2 {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    #leaderboard-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px; /* for scrollbar */
    }
    #leaderboard-container::-webkit-scrollbar {
      width: 8px;
    }
    #leaderboard-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }
    #leaderboard-container::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg,#4facfe,#00f2fe);
      border-radius: 10px;
    }
    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 0.95em;
      transition: background 0.2s ease;
    }
    .leaderboard-entry:hover {
        background: rgba(255,255,255,0.15);
    }
    .leaderboard-entry .rank {
      font-weight: bold;
      color: #4facfe;
      flex-basis: 10%;
      text-align: left;
    }
    .leaderboard-entry .name {
      flex-basis: 40%;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .leaderboard-entry .city {
      flex-basis: 30%;
      text-align: left;
      color: rgba(255,255,255,0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .leaderboard-entry .time {
      font-weight: bold;
      flex-basis: 20%;
      text-align: right;
    }
    .leaderboard-loading {
        padding: 20px;
        color: rgba(255,255,255,0.8);
    }

    /* --- STILI COMUNI --- */
    button {
      width:100%;background:linear-gradient(45deg,#4facfe,#00f2fe);
      border:none;color:white;padding:15px;font-size:1.1em;border-radius:50px;
      cursor:pointer;margin:20px 0 10px;transition:all 0.3s ease;
      box-shadow:0 4px 15px rgba(0,0,0,0.2);font-weight:600;
      touch-action:manipulation;min-height:48px;
    }
    button:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}
    button:active{transform:translateY(0);}
    button:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
    .loading{display:none;color:rgba(255,255,255,0.8);margin:10px 0;}
    .error{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);
      border-radius:10px;padding:12px;margin:10px 0;color:#ff6b6b;
      font-size:0.9em;display:none;}
    .success{background:rgba(0,255,0,0.2);border:1px solid rgba(0,255,0,0.5);
      border-radius:10px;padding:12px;margin:10px 0;color:#51cf66;
      font-size:0.9em;display:none;}
    
    /* --- UTILITY --- */
    .hidden {display:none !important;}
    .user-info {
      background:rgba(255,255,255,0.1);
      border-radius:10px;padding:10px;margin-bottom:20px;
      text-align:right;font-size:0.9em;
    }
    .logout-btn {
      width:auto;padding:8px 15px;font-size:0.8em;margin:5px 0;
      background:rgba(255,255,255,0.2);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {padding:5px;}
      .container {
        padding:25px;
        width:95%;
        border-radius:15px;
      }
      h1 {
        font-size:1.8em;
        margin-bottom:15px;
      }
      button {
        font-size:1em;
        padding:12px 25px;
      }
      .results {padding:15px;}
      .metric {
        flex-direction:column;
        gap:5px;
        align-items:flex-start;
      }
      .metric-value {
        align-self:flex-end;
      }
    }
    
    @media (max-width: 480px) {
      h1 {font-size:1.5em;}
      .container {padding:20px;}
      button {
        font-size:0.9em;
        padding:10px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- SEZIONE AUTENTICAZIONE -->
    <div id="auth-section" class="auth-section">
      <h1>üîê Accedi</h1>
      <p class="subtitle">Accedi per testare la tua GPU</p>

      <div class="form-tabs">
        <button class="tab-button active" onclick="switchTab('login')">Accedi</button>
        <button class="tab-button" onclick="switchTab('register')">Registrati</button>
      </div>

      <div class="form-container">
        <!-- LOGIN -->
        <div id="login-form" class="form-content active">
          <form onsubmit="handleLogin(event)">
            <div class="form-group">
              <label for="login-email">Email</label>
              <input type="email" id="login-email" placeholder="tua@email.com" required>
            </div>
            <div class="form-group">
              <label for="login-password">Password</label>
              <input type="password" id="login-password" placeholder="La tua password" required>
            </div>
            <div class="error" id="login-error"></div>
            <div class="success" id="login-success"></div>
            <div class="loading" id="login-loading">üîÑ Accesso in corso...</div>
            <button type="submit" id="login-btn">üöÄ Accedi</button>
          </form>
        </div>

        <!-- REGISTRAZIONE -->
        <div id="register-form" class="form-content">
          <form onsubmit="handleRegister(event)">
            <div class="form-group">
              <label for="register-name">Nome Completo</label>
              <input type="text" id="register-name" placeholder="Mario Rossi" required>
            </div>
            <div class="form-group">
              <label for="register-email">Email</label>
              <input type="email" id="register-email" placeholder="mario@email.com" required>
            </div>
            <div class="form-group">
              <label for="register-password">Password</label>
              <input type="password" id="register-password" placeholder="Minimo 6 caratteri" required minlength="6">
            </div>
            <div class="form-group">
              <label for="confirm-password">Conferma Password</label>
              <input type="password" id="confirm-password" placeholder="Ripeti la password" required>
            </div>

            <div class="location-grid">
              <div class="form-group">
                <label for="region">Regione</label>
                <select id="region" required onchange="loadProvinces()">
                  <option value="">Seleziona Regione</option>
                </select>
              </div>
              <div class="form-group">
                <label for="province">Provincia</label>
                <select id="province" required>
                  <option value="">Prima seleziona Regione</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="city">Comune</label>
              <input type="text" id="city" placeholder="Inserisci il tuo comune" required>
            </div>

            <div class="error" id="register-error"></div>
            <div class="success" id="register-success"></div>
            <div class="loading" id="register-loading">üìù Registrazione in corso...</div>

            <button type="submit" id="register-btn">‚ú® Registrati</button>
          </form>
        </div>
      </div>
      
      <!-- SEZIONE CLASSIFICA -->
      <div id="leaderboard-section">
        <h2>üèÜ Classifica Globale</h2>
        <div id="leaderboard-container">
          <!-- Le voci della classifica verranno inserite qui da JavaScript -->
        </div>
      </div>

    </div>

    <!-- SEZIONE TEST GPU -->
    <div id="gpu-section" class="gpu-section hidden">
      <div class="user-info">
        <span id="user-email"></span>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
      
      <h1>‚ö° GPU velocit√† Test</h1>

      <!-- Contenitore per il record dell'utente -->
      <div id="user-record-box" class="user-record-box">
          <h4>Il tuo record personale</h4>
          <span id="user-record" class="metric-value">Nessun record</span>
      </div>
      
      <div id="device-info" class="device-info">
        <div id="device-details"></div>
      </div>
      
      <!-- Desktop: Solo WebGPU button -->
      <div id="desktop-controls">
        <button id="webgpu-test" onclick="startWebGPUTest()" disabled>Avvia Test GPU</button>
      </div>
      
      <!-- Mobile: Solo WebGPU -->
      <div id="mobile-controls" class="mobile-buttons" style="display:none;">
        <button id="webgpu-mobile" onclick="startWebGPUTest()" disabled>üöÄ Test GPU</button>
      </div>
      
      <div class="progress" id="progress-container" style="display:none;">
        <div class="progress-bar" id="progress-bar"></div>
        <div id="progress-text" class="progress-text"></div>
      </div>
      
      <div id="results" class="results" style="display:none;">
        <h3>üìä Risultati Test</h3>
        <div id="metrics"></div>
      </div>
    </div>
  </div>

  <script>
    // --- FUNZIONI GLOBALI (fuori dal modulo per onclick) ---
    let currentTab='login';
    
    function switchTab(tab){
      document.querySelectorAll('.tab-button').forEach(btn=>btn.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.querySelectorAll('.form-content').forEach(form=>form.classList.remove('active'));
      document.getElementById(`${tab}-form`).classList.add('active');
      currentTab=tab;
    }

    function loadProvinces() {
      const region = document.getElementById('region').value;
      const provinceSelect = document.getElementById('province');
      const provinceByRegion = window.provinceByRegion || {};
      
      provinceSelect.innerHTML = '<option value="">Seleziona Provincia</option>';
      if (region && provinceByRegion[region]) {
        provinceByRegion[region].forEach(prov => {
          const opt = document.createElement('option');
          opt.value = prov;
          opt.textContent = prov;
          provinceSelect.appendChild(opt);
        });
      }
    }

    // Funzioni che verranno definite nel modulo
    function handleLogin(event) {
      event.preventDefault(); // Aggiunto per evitare il ricaricamento della pagina
      if (window.moduleHandleLogin) window.moduleHandleLogin(event);
    }
    
    function handleRegister(event) {
      event.preventDefault(); // Aggiunto per evitare il ricaricamento della pagina
      if (window.moduleHandleRegister) window.moduleHandleRegister(event);
    }
    
    function handleLogout() {
      if (window.moduleHandleLogout) window.moduleHandleLogout();
    }
    
    function startWebGPUTest() {
      if (window.moduleStartWebGPUTest) window.moduleStartWebGPUTest();
    }
  </script>

  <script type="module">
    // Importa i moduli necessari da Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, getDoc, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- CONFIGURAZIONE E INIZIALIZZAZIONE FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyDnhIjY5MQreMbr8-lMSGiiaZgTsTbsFAo",
      authDomain: "x4-game-b38ea.firebaseapp.com",
      projectId: "x4-game-b38ea",
      storageBucket: "x4-game-b38ea.firebasestorage.app",
      messagingSenderId: "234053148794",
      appId: "1:234053148794:web:1eadb88554aa3c1058dbc3",
      measurementId: "G-34MSCWGN5P"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- VARIABILI GLOBALI ---
    let currentUser = null;
    let gpuInfo = {};
    let testRunning = false;
    let isMobile = false;

    // --- GESTIONE AUTENTICAZIONE ---
    function showAuthSection() {
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('gpu-section').classList.add('hidden');
    }

    async function showGPUSection() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('gpu-section').classList.remove('hidden');
      
      await loadUserRecord();
      detectGPU();
    }

    function showMessage(type, message, formId) {
      const errorDiv = document.getElementById(`${formId}-error`);
      const successDiv = document.getElementById(`${formId}-success`);
      const loadingDiv = document.getElementById(`${formId}-loading`);
      const btn = document.getElementById(`${formId}-btn`);

      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      loadingDiv.style.display = 'none';
      if(btn) btn.disabled = false;

      if (type === 'loading') {
        loadingDiv.style.display = 'block';
        if(btn) btn.disabled = true;
      } else if (type === 'error') {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      } else if (type === 'success') {
        successDiv.textContent = message;
        successDiv.style.display = 'block';
      }
    }

    function getErrorMessage(code) {
      switch(code) {
        case 'auth/email-already-in-use': return 'Questa email √® gi√† registrata.';
        case 'auth/invalid-email': return 'L\'indirizzo email non √® valido.';
        case 'auth/wrong-password': return 'La password inserita non √® corretta.';
        case 'auth/user-not-found': 
        case 'auth/invalid-credential': return 'Le credenziali inserite non sono valide. Controlla email e password, o registrati se non l\'hai ancora fatto.';
        case 'auth/weak-password': return 'La password deve contenere almeno 6 caratteri.';
        case 'auth/missing-password': return 'Inserisci la password.';
        default: return `Si √® verificato un errore: ${code}`;
      }
    }

    async function handleLogin(e) {
      // La prevenzione del default √® gi√† nella funzione globale
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const formId = 'login';

      showMessage('loading', '', formId);

      try {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('success', 'Accesso effettuato con successo! üéâ', formId);
      } catch (error) {
        console.error("Login failed:", error);
        showMessage('error', getErrorMessage(error.code), formId);
      }
    }

    async function handleRegister(e) {
      // La prevenzione del default √® gi√† nella funzione globale
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      const name = document.getElementById('register-name').value;
      const region = document.getElementById('region').value;
      const province = document.getElementById('province').value;
      const city = document.getElementById('city').value;
      const formId = 'register';

      if (password !== confirmPassword) {
        showMessage('error', 'Le password non corrispondono.', formId);
        return;
      }

      showMessage('loading', '', formId);

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        await setDoc(doc(db, "users", user.uid), {
          name: name,
          email: email,
          region: region,
          province: province,
          city: city,
          createdAt: new Date()
        });

        showMessage('success', 'Registrazione completata con successo! üéâ', formId);
      } catch (error) {
        console.error("Registration failed:", error);
        showMessage('error', getErrorMessage(error.code), formId);
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        currentUser = null;
        showAuthSection();
      } catch (error) {
        console.error("Logout failed:", error);
      }
    }

    async function loadUserRecord() {
      const recordBox = document.getElementById('user-record-box');
      const recordDisplay = document.getElementById('user-record');
      
      recordBox.style.display = 'none';
      recordDisplay.textContent = 'Nessun record';

      if (!currentUser) return;

      try {
        const userRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userRef);

        if (userDoc.exists()) {
          const userData = userDoc.data();
          if (userData.bestGPUTimeFormatted) {
            recordDisplay.textContent = userData.bestGPUTimeFormatted;
            recordBox.style.display = 'block';
          }
        }
      } catch (error) {
        console.error("Errore nel caricare il record dell'utente:", error);
      }
    }

    // --- GESTIONE CLASSIFICA ---
    function displayLeaderboard() {
      const leaderboardContainer = document.getElementById('leaderboard-container');
      if (!leaderboardContainer) return;

      leaderboardContainer.innerHTML = '<div class="leaderboard-loading">Caricamento classifica...</div>';

      const usersRef = collection(db, "users");
      const q = query(usersRef, where("bestGPUTime", ">", 0), orderBy("bestGPUTime"));

      onSnapshot(q, (querySnapshot) => {
        if (querySnapshot.empty) {
          leaderboardContainer.innerHTML = '<div class="leaderboard-loading">Nessun dato da mostrare.</div>';
          return;
        }

        let rank = 1;
        let html = '';
        querySnapshot.forEach((doc) => {
          const user = doc.data();
          if (user.name && user.city && user.bestGPUTimeFormatted) {
            html += `
              <div class="leaderboard-entry">
                <span class="rank">${rank}.</span>
                <span class="name">${user.name}</span>
                <span class="city">${user.city}</span>
                <span class="time">${user.bestGPUTimeFormatted}</span>
              </div>
            `;
            rank++;
          }
        });
        leaderboardContainer.innerHTML = html;
      }, (error) => {
        console.error("Errore nel caricare la classifica: ", error);
        leaderboardContainer.innerHTML = '<div class="leaderboard-loading" style="color: #ff6b6b;">Impossibile caricare la classifica. Controlla le regole di sicurezza di Firestore.</div>';
      });
    }

    // --- GESTIONE REGIONI E PROVINCE ---
    const provinceByRegion = {
      "Abruzzo": ["L'Aquila","Chieti","Pescara","Teramo"], "Basilicata": ["Potenza","Matera"], "Calabria": ["Catanzaro","Cosenza","Crotone","Reggio Calabria","Vibo Valentia"], "Campania": ["Avellino","Benevento","Caserta","Napoli","Salerno"], "Emilia-Romagna": ["Bologna","Ferrara","Forl√¨-Cesena","Modena","Parma","Piacenza","Ravenna","Reggio Emilia","Rimini"], "Friuli Venezia Giulia": ["Gorizia","Pordenone","Trieste","Udine"], "Lazio": ["Frosinone","Latina","Rieti","Roma","Viterbo"], "Liguria": ["Genova","Imperia","La Spezia","Savona"], "Lombardia": ["Bergamo","Brescia","Como","Cremona","Lecco","Lodi","Mantova","Milano","Monza e Brianza","Pavia","Sondrio","Varese"], "Marche": ["Ancona","Ascoli Piceno","Fermo","Macerata","Pesaro e Urbino"], "Molise": ["Campobasso","Isernia"], "Piemonte": ["Alessandria","Asti","Biella","Cuneo","Novara","Torino","Verbano-Cusio-Ossola","Vercelli"], "Puglia": ["Bari","Barletta-Andria-Trani","Brindisi","Foggia","Lecce","Taranto"], "Sardegna": ["Cagliari","Nuoro","Oristano","Sassari","Sud Sardegna"], "Sicilia": ["Agrigento","Caltanissetta","Catania","Enna","Messina","Palermo","Ragusa","Siracusa","Trapani"], "Toscana": ["Arezzo","Firenze","Grosseto","Livorno","Lucca","Massa-Carrara","Pisa","Pistoia","Prato","Siena"], "Trentino-Alto Adige": ["Bolzano","Trento"], "Umbria": ["Perugia","Terni"], "Valle d'Aosta": ["Aosta"], "Veneto": ["Belluno","Padova","Rovigo","Treviso","Venezia","Verona","Vicenza"]
    };
    window.provinceByRegion = provinceByRegion;

    function loadRegions() {
      const regionSelect = document.getElementById('region');
      Object.keys(provinceByRegion).forEach(region => {
        const opt = document.createElement('option');
        opt.value = region;
        opt.textContent = region;
        regionSelect.appendChild(opt);
      });
    }

    // --- GESTIONE TEST GPU ---
    // (Il resto del codice per il test GPU rimane invariato)
    async function detectGPU() {
      isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isTablet = /iPad|Android(?=.*(?:Tablet|Tab))/i.test(navigator.userAgent);
      const browser = getBrowserInfo();
      
      showDeviceInfo(isMobile, isTablet, browser);
      
      if (isMobile) {
        document.getElementById("desktop-controls").style.display = "none";
        document.getElementById("mobile-controls").style.display = "flex";
      }
      
      if ('gpu' in navigator) {
        try {
          const adapter = await navigator.gpu.requestAdapter();
          if (adapter) {
            gpuInfo.webgpu = true;
            gpuInfo.adapter = adapter;
            
            if (isMobile) {
              document.getElementById("webgpu-mobile").disabled = false;
            } else {
              document.getElementById("webgpu-test").disabled = false;
            }
          }
        } catch (err) {
          console.log("WebGPU non disponibile:", err);
        }
      }
    }

    function getBrowserInfo() {
      const ua = navigator.userAgent;
      if (ua.includes('Chrome')) return 'Chrome';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Edge')) return 'Edge';
      return 'Sconosciuto';
    }

    function showDeviceInfo(isMobile, isTablet, browser) {
      const deviceType = isTablet ? 'üì± Tablet' : isMobile ? 'üì± Mobile' : 'üíª Desktop';
      const gpu = getGPUInfo();
      
      document.getElementById("device-details").innerHTML = `
        <strong>Dispositivo:</strong> ${deviceType} | <strong>Browser:</strong> ${browser}<br>
        <strong>Risoluzione:</strong> ${screen.width}√ó${screen.height} | <strong>Pixel Ratio:</strong> ${devicePixelRatio}<br>
        <strong>GPU Info:</strong> ${gpu}
      `;
      document.getElementById("device-info").style.display = "block";
    }

    function getGPUInfo() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) return 'WebGL non supportato';
        
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
          const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
          return `${vendor} - ${renderer}`;
        }
        return gl.getParameter(gl.RENDERER);
      } catch (e) {
        return 'Info GPU non disponibili';
      }
    }

    async function startWebGPUTest() {
      if (testRunning) return;
      testRunning = true;

      if (!gpuInfo.webgpu) {
        alert("WebGPU non supportato");
        testRunning = false;
        return;
      }

      try {
        showProgress(isMobile ? "Test WebGPU Mobile in corso..." : "Test WebGPU in corso...");
        const adapter = gpuInfo.adapter;
        const device = await adapter.requestDevice();

        const dataSize = isMobile ? 1_000_000 : 5_000_000;
        const iterations = isMobile ? 15 : 30;
        const shaderIterations = isMobile ? 1000 : 2000;
        const workgroupSize = isMobile ? 64 : 256;

        const computeShader = `
          @group(0) @binding(0) var<storage, read_write> data: array<f32>;
          @compute @workgroup_size(${workgroupSize})
          fn main(@builtin(global_invocation_id) global_id: vec3<u32>) {
            let index = global_id.x;
            if (index >= arrayLength(&data)) { return; }
            var value = data[index];
            for (var i = 0u; i < ${shaderIterations}u; i++) {
              let x = value + f32(i) * 0.001;
              value += sin(x) * cos(x * 2.0);
              value += sqrt(abs(value)) + pow(abs(sin(x)), 0.5);
              value += log(abs(value) + 1.0);
            }
            data[index] = value;
          }
        `;

        const module = device.createShaderModule({ code: computeShader });
        const pipeline = device.createComputePipeline({
          layout: "auto",
          compute: { module, entryPoint: "main" }
        });

        const inputData = new Float32Array(dataSize);
        for (let i = 0; i < dataSize; i++) inputData[i] = i * 0.001;

        const buffer = device.createBuffer({
          size: inputData.byteLength,
          usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_DST
        });
        device.queue.writeBuffer(buffer, 0, inputData);

        const bindGroup = device.createBindGroup({
          layout: pipeline.getBindGroupLayout(0),
          entries: [{ binding: 0, resource: { buffer } }]
        });

        const startTime = performance.now();

        for (let iter = 0; iter < iterations; iter++) {
          const encoder = device.createCommandEncoder();
          const pass = encoder.beginComputePass();
          pass.setPipeline(pipeline);
          pass.setBindGroup(0, bindGroup);
          pass.dispatchWorkgroups(Math.ceil(dataSize / workgroupSize));
          pass.end();
          device.queue.submit([encoder.finish()]);
          updateProgress((iter / iterations) * 100);
          
          await new Promise(res => setTimeout(res, isMobile ? 10 : 1));
        }

        await device.queue.onSubmittedWorkDone();
        const elapsed = (performance.now() - startTime) / 1000;
        const totalOps = dataSize * iterations * shaderIterations;

        const results = {
          "Tempo": `${elapsed.toFixed(2)}s`,
          "Elementi": dataSize.toLocaleString(),
          "Iterazioni": iterations,
          "Operazioni totali": `${(totalOps/1e9).toFixed(2)}B`,
          "GFLOPS": `${(totalOps/elapsed/1e9).toFixed(2)}`,
          "Throughput": `${(dataSize*iterations/elapsed/1e6).toFixed(1)}M elem/sec`
        };
        
        if (isMobile) {
          results["Modalit√†"] = "Mobile (ottimizzato)";
        }
        
        await saveTestResults(results);
        finishTest("WebGPU", results);

      } catch (err) {
        alert("Errore WebGPU: " + err.message);
        testRunning = false;
        hideProgress();
      }
    }

    async function saveTestResults(results) {
      if (!currentUser) return;
      
      try {
        const currentTime = parseFloat(results.Tempo.replace('s', ''));
        const deviceType = isMobile ? 'mobile' : 'desktop';
        
        const userRef = doc(db, "users", currentUser.uid);
        const userDoc = await getDoc(userRef);
        
        let shouldUpdate = true;
        
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const existingBestTime = userData.bestGPUTime;
          
          if (existingBestTime && currentTime >= existingBestTime) {
            console.log(`Tempo attuale (${currentTime}s) non migliore del record (${existingBestTime}s). Non salvato.`);
            shouldUpdate = false;
          }
        }
        
        if (shouldUpdate) {
            await updateDoc(userRef, {
              bestGPUTime: currentTime,
              bestGPUTimeFormatted: results.Tempo,
              lastTestDate: new Date(),
              deviceType: deviceType,
              lastTestInfo: {
                browser: getBrowserInfo(),
                screenResolution: `${screen.width}√ó${screen.height}`,
                gpuInfo: getGPUInfo()
              }
            });
            console.log(`üéâ Nuovo record salvato per utente ${currentUser.email}: ${results.Tempo}`);
            await loadUserRecord(); 
        }
        
      } catch (error) {
        console.error("Errore nel salvare i risultati:", error);
      }
    }

    function showProgress(message = "") {
      document.getElementById("progress-container").style.display = "block";
      document.getElementById("results").style.display = "none";
      document.getElementById("progress-text").textContent = message;
      
      const buttons = isMobile ? 
        document.querySelectorAll("#mobile-controls button") :
        document.querySelectorAll("#desktop-controls button");
      buttons.forEach(btn => btn.disabled = true);
    }

    function updateProgress(percent) {
      document.getElementById("progress-bar").style.width = percent + "%";
      document.getElementById("progress-text").textContent = `${Math.round(percent)}% completato`;
    }

    function hideProgress() {
      document.getElementById("progress-container").style.display = "none";
    }

    function finishTest(type, metrics) {
      hideProgress();
      testRunning = false;
      
      const buttons = isMobile ? 
        document.querySelectorAll("#mobile-controls button") :
        document.querySelectorAll("#desktop-controls button");
      buttons.forEach(btn => btn.disabled = false);
      
      if (!gpuInfo.webgpu) {
        if (isMobile) {
          document.getElementById("webgpu-mobile").disabled = true;
        } else {
          document.getElementById("webgpu-test").disabled = true;
        }
      }
      
      const metricsDiv = document.getElementById("metrics");
      metricsDiv.innerHTML = `
        <h4>‚úÖ Test ${type} completato</h4>
        ${Object.entries(metrics).map(([k,v]) => 
          `<div class="metric"><span>${k}:</span><span class="metric-value">${v}</span></div>`
        ).join("")}
      `;
      document.getElementById("results").style.display = "block";
      document.getElementById("results").scrollIntoView({behavior:"smooth"});
    }

    // --- INIZIALIZZAZIONE ---
    window.addEventListener("load", () => {
      loadRegions();
      displayLeaderboard(); // Carica la classifica al caricamento della pagina
    });

    // Rende le funzioni disponibili globalmente
    window.moduleHandleLogin = handleLogin;
    window.moduleHandleRegister = handleRegister;
    window.moduleHandleLogout = handleLogout;
    window.moduleStartWebGPUTest = startWebGPUTest;

    // Monitor dello stato di autenticazione
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        console.log("Utente autenticato:", user.email);
        document.getElementById("user-email").textContent = user.email;
        showGPUSection();
      } else {
        currentUser = null;
        console.log("Nessun utente autenticato.");
        showAuthSection();
      }
    });

  </script>
</body>
</html>
